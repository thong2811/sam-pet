<?php
/**
 * @var Laminas\View\Renderer\PhpRenderer $this
 */

$treatmentProfitPercent = \Application\Model\VetCare::TREATMENT_PROFIT_PERCENT;
$exportStockTotalAmountByDate = $this->exportStockTotalAmountByDate ?? [];
$vetCareTotalAmountByDate = $this->vetCareTotalAmountByDate ?? [];
$expensesTotalAmountByDate = $this->expensesTotalAmountByDate ?? [];
$savingsTotalAmountByDate = $this->savingsTotalAmountByDate ?? [];
?>
<div>
    <input type="hidden" id="exportStockTotalAmountByDate" value='<?= json_encode($exportStockTotalAmountByDate) ?>'>
    <input type="hidden" id="vetCareTotalAmountByDate" value='<?= json_encode($vetCareTotalAmountByDate) ?>'>
    <input type="hidden" id="expensesTotalAmountByDate" value='<?= json_encode($expensesTotalAmountByDate) ?>'>
    <input type="hidden" id="savingsTotalAmountByDate" value='<?= json_encode($savingsTotalAmountByDate) ?>'>
</div>
<div class="mt-5">
    <h1 class="mb-5"> Báo cáo thu - chi </h1>
    <div class="container row" style="font-size: 10px">
        <div class="alert alert-info p-2 col-2 float-start">Tổng thu:
            <span class="fw-bold" id="totalRevenue"></span>
        </div>
        <div class="alert alert-info p-2 col-2 float-start ms-2">Tổng chi:
            <span class="fw-bold" id="totalExpenses"></span>
        </div>
        <div class="alert alert-info p-2 col-2 float-start ms-2">Tiền dư/thiếu:
            <span class="fw-bold" id="totalMissingAmount"></span>
        </div>
        <div class="alert alert-info p-2 col-2 float-start ms-2">Tiền còn lại:
            <span class="fw-bold" id="totalProfit"></span>
        </div>
    </div>
    <div class="my-2">
        <button class="btn btn-primary" onclick="openAddModal()">Thêm mới +</button>
    </div>
    <table id="dataTable" class="table table-striped" style="width:100%">
        <thead>
        <tr>
            <th>STT</th>
            <th style="width: 70px;">Ngày</th>
            <th>Thu pet shop</th>
            <th>Lãi pet shop</th>
            <th>Thu spa</th>
            <th>Thu điều trị</th>
            <th>Lãi điều trị</th>
            <th>Tổng thu</th>
            <th>Tổng chi</th>
            <th>Rút tiền tiết kiệm</th>
            <th>Còn lại</th>
            <th>Tiền dư/thiếu</th>
            <th>Ghi chú</th>
            <th>Thao tác</th>
        </tr>
        </thead>
    </table>
</div>
<div id="editReportModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật báo cáo ngày</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="eidtReport" method="post">
                    <input type="hidden" id="reportId" name="id">
                    <div class="mb-3">
                        <label class="form-label">Ngày</label>
                        <input type="text" class="form-control date-picker" id="date" name="date" autocomplete="off" onchange="reloadReportByDate('#editReport')" required/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tiền dư/thiếu</label>
                        <div class="input-group">
                            <span class="input-group-text">VNĐ</span>
                            <input type="text" class="form-control" id="missingAmount" name="missingAmount">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea id="note" class="form-control" name="note"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tính tiền (Tự động tính khi thay đổi ngày)</label>
                        <div class="card p-3 bg-light">
                            <div class="col-12 float-start">
                                <label class="form-label col-12">Pet shop</label>
                                <div class="mb-3 col-5 float-start">
                                    <div class="input-group">
                                        <span class="input-group-text">Doanh thu</span>
                                        <input type="text" class="form-control" id="petShopRevenue" name="petShopRevenue" required readonly>
                                    </div>
                                </div>
                                <div class="mb-3 col-5 float-end">
                                    <div class="input-group">
                                        <span class="input-group-text">Lãi</span>
                                        <input type="text" class="form-control" id="petShopProfit" name="petShopProfit" required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Thu spa</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="spaRevenue" name="spaRevenue" required readonly>
                                </div>
                            </div>
                            <div class="col-12 float-start">
                                <label class="form-label col-12">Điều trị</label>
                                <div class="mb-3 col-5 float-start">
                                    <div class="input-group">
                                        <span class="input-group-text">Doanh thu</span>
                                        <input type="text" class="form-control" id="treatmentRevenue" name="treatmentRevenue" required readonly>
                                    </div>
                                </div>
                                <div class="mb-3 col-5 float-end">
                                    <div class="input-group">
                                        <span class="input-group-text">Lãi (<?= $treatmentProfitPercent*100 ?>%)</span>
                                        <input type="text" class="form-control" id="treatmentProfit" name="treatmentProfit" required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tổng thu</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="revenue" name="revenue" required readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tổng chi</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="expenses" name="expenses" required readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rút tiền tiết kiệm</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="savings" name="savings" required readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Còn lại</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="remaining" required readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="doEdit()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<div id="addReportModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm báo cào ngày
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addReport" method="post">
                    <div class="mb-3">
                        <label class="form-label">Ngày</label>
                        <input type="text" class="form-control date-picker" id="date" name="date" autocomplete="off" onchange="reloadReportByDate('#addReport')" required/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tiền dư/thiếu</label>
                        <div class="input-group">
                            <span class="input-group-text">VNĐ</span>
                            <input type="text" class="form-control" id="missingAmount" name="missingAmount">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea id="note" class="form-control" name="note"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tính tiền (Tự động tính khi thay đổi ngày)</label>
                        <div class="card p-3 bg-light">
                            <div class="col-12 float-start">
                                <label class="form-label col-12">Pet shop</label>
                                <div class="mb-3 col-5 float-start">
                                    <div class="input-group">
                                        <span class="input-group-text">Doanh thu</span>
                                        <input type="text" class="form-control" id="petShopRevenue" name="petShopRevenue" required readonly>
                                    </div>
                                </div>
                                <div class="mb-3 col-5 float-end">
                                    <div class="input-group">
                                        <span class="input-group-text">Lãi</span>
                                        <input type="text" class="form-control" id="petShopProfit" name="petShopProfit" required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Thu spa</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="spaRevenue" name="spaRevenue" required readonly>
                                </div>
                            </div>
                            <div class="col-12 float-start">
                                <label class="form-label col-12">Điều trị</label>
                                <div class="mb-3 col-5 float-start">
                                    <div class="input-group">
                                        <span class="input-group-text">Doanh thu</span>
                                        <input type="text" class="form-control" id="treatmentRevenue" name="treatmentRevenue" required readonly>
                                    </div>
                                </div>
                                <div class="mb-3 col-5 float-end">
                                    <div class="input-group">
                                        <span class="input-group-text">Lãi (<?= $treatmentProfitPercent*100 ?>%)</span>
                                        <input type="text" class="form-control" id="treatmentProfit" name="treatmentProfit" required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tổng thu</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="revenue" name="revenue" required readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tổng chi</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="expenses" name="expenses" required readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rút tiền tiết kiệm</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="savings" name="savings" required readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Còn lại</label>
                                <div class="input-group">
                                    <span class="input-group-text">VNĐ</span>
                                    <input type="text" class="form-control" id="remaining" required readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="doAdd()">Thêm</button>
            </div>
        </div>
    </div>
</div>
<script>
    const controllerName = 'report';

    let exportStockTotalAmountByDate = [];
    let vetCareTotalAmountByDate = [];
    let expensesTotalAmountByDate = [];
    let savingsTotalAmountByDate = [];

    $(function () {
        initVariable();
    })

    const table = initDataTable('#dataTable', {
        ...DATA_TABLES_CONFIG,
        ajax: {
            url: `/${controllerName}/data-table-server-side`,
            type: 'POST',
            dataSrc: (json) => {
                reloadHeaderInfo(json);
                return json.data || {};
            }
        },
        columns: [
            { name: 'no', data: 'no' },
            { name: 'date', data: 'date' },
            { name: 'petShopRevenue', data: 'petShopRevenue', render: $.fn.dataTable.render.number( ',') },
            { name: 'petShopProfit', data: 'petShopProfit', render: $.fn.dataTable.render.number( ',') },
            { name: 'spaRevenue', data: 'spaRevenue', render: $.fn.dataTable.render.number( ',') },
            { name: 'treatmentRevenue', data: 'treatmentRevenue', render: $.fn.dataTable.render.number( ',') },
            { name: 'treatmentProfit', data: 'treatmentProfit', render: $.fn.dataTable.render.number( ',') },
            { name: 'revenue', data: 'revenue', render: $.fn.dataTable.render.number( ',') },
            { name: 'expenses', data: 'expenses', render: $.fn.dataTable.render.number( ',') },
            { name: 'savings', data: 'savings', render: $.fn.dataTable.render.number( ',') },
            { name: 'remaining', data: 'remaining', render: $.fn.dataTable.render.number( ',') },
            { name: 'missingAmount', data: 'missingAmount', render: $.fn.dataTable.render.number( ',') },
            { name: 'note', data: 'note' },
            { name: 'action', data: 'action' }
        ],
        serverSide: true
    });

    function reloadHeaderInfo(json) {
        const totalRevenue = json.totalRevenue || 0;
        const totalExpenses = json.totalExpenses || 0;
        const totalMissingAmount = json.totalMissingAmount || 0;
        const totalProfit = totalRevenue - totalExpenses + totalMissingAmount;

        $('#totalRevenue').html(formatNumber(totalRevenue) + ' VNĐ');
        $('#totalExpenses').html(formatNumber(totalExpenses) + ' VNĐ');
        $('#totalMissingAmount').html(formatNumber(totalMissingAmount) + ' VNĐ');
        $('#totalProfit').html(formatNumber(totalProfit) + ' VNĐ');
    }

    // add, update, remove
    const editModalId = '#editReportModal';
    const editModal = initModal(editModalId);

    const addModalId = '#addReportModal';
    const addModal = initModal(addModalId);

    function openEditModal(id) {
        clearModalForm(editModalId);
        const data = getDataById(id);

        loadEditModalData(data);
        editModal.show();
    }

    function openAddModal() {
        clearModalForm(addModalId);
        addModal.show();
    }

    function getDataById(id) {
        const data = table.data().toArray();

        const row = data.find((row) => {
            return row.id && row.id === id;
        })

        return row || {};
    }

    function loadEditModalData(data) {
        const date = data.date || '';
        const reportId = data.id || '';
        const missingAmount = data.missingAmount || '';
        const note = data.note || '';

        $(editModalId).find('#date').val(date);
        $(editModalId).find('#reportId').val(reportId);
        $(editModalId).find('#reportId').val(reportId);
        $(editModalId).find('#missingAmount').val(missingAmount);
        $(editModalId).find('#note').val(note);

        reloadReportByDate(editModalId, date);
    }

    function doAdd() {
        if (!validateModalForm(addModalId)) {
            return;
        }

        if ($(addModalId + " #petShopRevenue").val() === "") {
            alert("Lỗi: Doanh thu pet shop đang rỗng !")
            return;
        }

        $.ajax({
            url: `/${controllerName}/do-add`,
            type: 'POST',
            data: $(addModalId).find('form').serialize(),
            success: function (response) {
                if (response.success) {
                    table.draw(false);
                    addModal.hide();
                    addFlashMessage(`Thêm thành công`);
                } else {
                    addFlashMessage(`Đã xảy ra lỗi khi thêm. ${response.message || 'error unknown'}`, FLASH_MESSAGE_TYPE_ERROR);
                }
            },
            error: function (xhr, status, error) {
                addFlashMessage('Đã xảy ra lỗi khi thêm: ' + error, FLASH_MESSAGE_TYPE_ERROR);
            }
        });
    }

    function doEdit() {
        if (!validateModalForm(editModalId)) {
            return;
        }

        if ($(editModalId + " #petShopRevenue").val() === "") {
            alert("Lỗi: Doanh thu pet shop đang rỗng !")
            return;
        }

        $.ajax({
            url: `/${controllerName}/do-edit`,
            type: 'POST',
            data: $(editModalId).find('form').serialize(),
            success: function (response) {
                if (response.success) {
                    table.draw(false);
                    editModal.hide();
                    addFlashMessage(`Cập nhật thành công`);
                } else {
                    addFlashMessage(`Đã xảy ra lỗi khi cập nhật. ${response.message || 'error unknown'}`, FLASH_MESSAGE_TYPE_ERROR);
                }
            },
            error: function (xhr, status, error) {
                addFlashMessage('Đã xảy ra lỗi khi cập nhật: ' + error, FLASH_MESSAGE_TYPE_ERROR);
            }
        });
    }

    function remove(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa?')) {
            return;
        }
        $.ajax({
            url: `/${controllerName}/do-delete`,
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ id: id }),
            success: function (response) {
                if (response.success) {
                    table.draw(false);
                    addFlashMessage(`Xoá thành công`);
                } else {
                    addFlashMessage(`Đã xảy ra lỗi khi xóa. ${response.message || 'error unknown'}`, FLASH_MESSAGE_TYPE_ERROR);
                }
            },
            error: function (xhr, status, error) {
                addFlashMessage('Đã xảy ra lỗi khi xóa: ' + error, FLASH_MESSAGE_TYPE_ERROR);
            }
        });
    }

    // calculate report
    function initVariable() {
        exportStockTotalAmountByDate = JSON.parse($('#exportStockTotalAmountByDate').val() ?? '{}');
        vetCareTotalAmountByDate = JSON.parse($('#vetCareTotalAmountByDate').val() ?? '{}');
        expensesTotalAmountByDate = JSON.parse($('#expensesTotalAmountByDate').val() ?? '{}');
        savingsTotalAmountByDate = JSON.parse($('#savingsTotalAmountByDate').val() ?? '{}');
    }

    function reloadReportByDate(formId, date = null) {
        if (date === null) {
            date = $(`${formId} #date`).val();
        }
        if (!exportStockTotalAmountByDate[date]) {
            alert("Không tìm thấy dữ liệu bán hàng để tính tự động !");
            return;
        } else if (!vetCareTotalAmountByDate[date]) {
            alert("Không tìm thấy dữ liệu điều trị, spa để tính tự động !");
            return;
        }

        const exportStock = exportStockTotalAmountByDate[date] ?? {};
        const vetCare = vetCareTotalAmountByDate[date] ?? {};

        const petShopRevenue = exportStock.revenue ?? 0;
        const petShopProfit = exportStock.profit ?? 0;
        $(`${formId} #petShopRevenue`).val(petShopRevenue);
        $(`${formId} #petShopProfit`).val(petShopProfit);

        const spaRevenue = vetCare.spa ?? 0;
        $(`${formId} #spaRevenue`).val(spaRevenue);

        const treatmentRevenue = vetCare.treatment ?? 0;
        const treatmentProfit = treatmentRevenue * <?= $treatmentProfitPercent ?>;
        $(`${formId} #treatmentRevenue`).val(treatmentRevenue);
        $(`${formId} #treatmentProfit`).val(treatmentProfit);

        const revenue = petShopRevenue + spaRevenue + treatmentRevenue;
        const expenses = expensesTotalAmountByDate[date] ?? 0;
        const savings = savingsTotalAmountByDate[date] ?? 0;
        $(`${formId} #revenue`).val(revenue);
        $(`${formId} #expenses`).val(expenses);
        $(`${formId} #savings`).val(savings);

        $(`${formId} #remaining`).val(revenue - expenses);
    }

</script>